# 在阿里云服务器上部署 Rys Assistant

在阿里云 ECS 等 Linux 服务器上运行 Rys Assistant，并让飞书能访问到 webhook。

---

## 一、服务器准备

### 1. 系统与 Node.js

- 系统：常见 Linux（如 CentOS 7+、Ubuntu 20.04+、Alibaba Cloud Linux）即可。
- 安装 **Node.js 18+**（推荐 20 LTS）：

```bash
# 方式一：NodeSource（Ubuntu/Debian）
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# 方式二：nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 20
nvm use 20
```

验证：

```bash
node -v   # 应 >= v18
npm -v
```

### 2. 放行端口

飞书要访问你服务器上的 webhook，需要从公网能访问到对应端口。

- **直接用端口 3000**：在阿里云安全组里放行 **入方向 TCP 3000**。
- **用 Nginx 做 HTTPS（推荐）**：放行 **80、443**，由 Nginx 转发到本机 3000。

---

## 二、部署代码

### 方式 A：Git 克隆（推荐）

```bash
cd /opt   # 或你习惯的目录
sudo mkdir -p /opt/rys-assistant
sudo chown $USER:$USER /opt/rys-assistant
cd /opt/rys-assistant

# 若项目在 Git 仓库
git clone <你的仓库地址> .
# 若只在本地，用 scp/rsync 把项目上传到服务器后解压到当前目录
```

### 方式 B：本地上传

在本地打包后上传到服务器：

```bash
# 本地（在项目根目录）
tar --exclude=node_modules --exclude=.git --exclude=dist -czvf rys-assistant.tar.gz .

# 上传到服务器
scp rys-assistant.tar.gz root@你的服务器IP:/opt/

# 服务器上
ssh root@你的服务器IP
cd /opt && mkdir -p rys-assistant && cd rys-assistant && tar -xzvf ../rys-assistant.tar.gz
```

---

## 三、安装依赖与构建

在服务器上进入项目目录执行：

```bash
cd /opt/rys-assistant   # 或你实际路径

npm install
npm run build
```

若安装 Puppeteer 时下载 Chromium 很慢，可先设镜像再安装：

```bash
export PUPPETEER_DOWNLOAD_HOST=https://npmmirror.com/mirrors
npm install
```

---

## 四、配置环境变量

在项目根目录创建 `.env`：

```bash
nano .env
```

至少填写（其他按需）：

```env
LARK_APP_ID=你的飞书 App ID
LARK_APP_SECRET=你的飞书 App Secret
LARK_VERIFICATION_TOKEN=飞书事件订阅校验 Token

DASHSCOPE_API_KEY=你的阿里云百炼 API Key
DASHSCOPE_MODEL=qwen-plus

PORT=3000
```

保存后确认当前目录下有 `.env` 且权限合适（仅当前用户可读即可）。

---

## 五、用 PM2 常驻运行（推荐）

用 [PM2](https://pm2.keymetrics.io/) 让进程常驻、崩溃自启、方便看日志：

```bash
# 安装 PM2
npm install -g pm2

# 启动（在项目根目录）
cd /opt/rys-assistant
pm2 start dist/index.js --name rys-assistant

# 开机自启
pm2 startup
pm2 save
```

常用命令：

```bash
pm2 status              # 状态
pm2 logs rys-assistant   # 日志
pm2 restart rys-assistant
pm2 stop rys-assistant
```

---

## 六、飞书回调地址

飞书需要访问 **公网可达的 URL**。

- **未配 Nginx**：  
  请求地址填：`http://你的服务器公网IP:3000/lark/webhook`  
  （需在安全组放行 3000，且飞书事件订阅支持 http；部分场景要求 https）
- **已配 Nginx（HTTPS）**：  
  请求地址填：`https://你的域名/lark/webhook`

在 [飞书开放平台](https://open.feishu.cn) → 你的应用 → 事件订阅 → 请求地址 中填写上述其一，保存并完成「请求 URL 校验」。

---

## 七、可选：Nginx 反向代理（HTTPS）

若你有域名并希望用 HTTPS（推荐），可装 Nginx 并反向代理到本机 3000。

### 1. 安装 Nginx 与证书

```bash
# CentOS / Aliyun Linux
sudo yum install -y nginx

# Ubuntu / Debian
sudo apt-get install -y nginx
```

证书可用阿里云免费 SSL 或 Let’s Encrypt，得到证书文件路径后继续。

### 2. 配置站点

新建配置（示例路径）：

```bash
sudo nano /etc/nginx/conf.d/rys-assistant.conf
```

内容示例（替换 `你的域名` 和证书路径）：

```nginx
server {
    listen 80;
    server_name 你的域名;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name 你的域名;

    ssl_certificate     /path/to/your/fullchain.pem;
    ssl_certificate_key /path/to/your/privkey.pem;

    location /lark/webhook {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

检查并重载 Nginx：

```bash
sudo nginx -t
sudo systemctl reload nginx
```

飞书事件订阅请求地址填：`https://你的域名/lark/webhook`。

---

## 八、自检清单

| 项 | 说明 |
|----|------|
| Node 版本 | `node -v` >= 18 |
| 构建 | `npm run build` 无报错 |
| .env | 飞书 + 百炼 Key 已填 |
| 进程 | `pm2 status` 里 rys-assistant 为 online |
| 端口 | 本机 `curl http://127.0.0.1:3000/lark/webhook` 能连（可能返回 400，属正常） |
| 安全组 | 3000 或 80/443 已放行 |
| 飞书 | 请求地址为 `http(s)://公网IP或域名:端口/lark/webhook` 且校验通过 |

---

## 九、常见问题

- **飞书校验失败**：确认请求地址与服务器实际监听一致（含 http/https、端口、路径 `/lark/webhook`），且安全组/防火墙已放行。
- **Puppeteer 报错**：无头浏览器需依赖，可 `sudo yum install -y chromium` 或按 [Puppeteer 文档](https://pptr.dev/guides/configuration) 安装依赖；或临时设 `BROWSER_ENABLED=false` 关闭浏览器能力。
- **进程退出**：用 `pm2 logs rys-assistant` 看报错；确认 `.env` 无误、端口未被占用。

部署完成后，在飞书里给机器人发消息即可测试。
